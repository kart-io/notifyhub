package main

import (
	"context"
	"fmt"
	"log"
	"time"

	"github.com/kart-io/notifyhub/client"
	"github.com/kart-io/notifyhub/config"
	"github.com/kart-io/notifyhub/notifiers"
)

// ================================
// æ¨¡æ‹Ÿ github.com/kart-io/logger çš„å®žçŽ°
// ================================

// MockKartLogger æ¨¡æ‹Ÿå®žçŽ°å®Œæ•´çš„ Kart Logger æŽ¥å£ï¼ˆæ”¯æŒç»“æž„åŒ–æ—¥å¿—ï¼‰
type MockKartLogger struct {
	prefix string
	fields map[string]interface{}
}

func NewMockKartLogger(prefix string) *MockKartLogger {
	return &MockKartLogger{
		prefix: prefix,
		fields: make(map[string]interface{}),
	}
}

func (m *MockKartLogger) Debug(msg string, fields ...interface{}) {
	m.log("DEBUG", msg, fields...)
}

func (m *MockKartLogger) Info(msg string, fields ...interface{}) {
	m.log("INFO", msg, fields...)
}

func (m *MockKartLogger) Warn(msg string, fields ...interface{}) {
	m.log("WARN", msg, fields...)
}

func (m *MockKartLogger) Error(msg string, fields ...interface{}) {
	m.log("ERROR", msg, fields...)
}

func (m *MockKartLogger) Debugf(format string, args ...interface{}) {
	m.log("DEBUG", fmt.Sprintf(format, args...))
}

func (m *MockKartLogger) Infof(format string, args ...interface{}) {
	m.log("INFO", fmt.Sprintf(format, args...))
}

func (m *MockKartLogger) Warnf(format string, args ...interface{}) {
	m.log("WARN", fmt.Sprintf(format, args...))
}

func (m *MockKartLogger) Errorf(format string, args ...interface{}) {
	m.log("ERROR", fmt.Sprintf(format, args...))
}

func (m *MockKartLogger) WithField(key string, value interface{}) interface{} {
	newFields := make(map[string]interface{})
	for k, v := range m.fields {
		newFields[k] = v
	}
	newFields[key] = value

	return &MockKartLogger{
		prefix: m.prefix,
		fields: newFields,
	}
}

func (m *MockKartLogger) WithFields(fields map[string]interface{}) interface{} {
	newFields := make(map[string]interface{})
	for k, v := range m.fields {
		newFields[k] = v
	}
	for k, v := range fields {
		newFields[k] = v
	}

	return &MockKartLogger{
		prefix: m.prefix,
		fields: newFields,
	}
}

func (m *MockKartLogger) log(level, msg string, fields ...interface{}) {
	timestamp := time.Now().Format("2006-01-02 15:04:05")
	output := fmt.Sprintf("[%s] [%s] %s%s", timestamp, level, m.prefix, msg)

	// æ·»åŠ çŽ°æœ‰å­—æ®µ
	if len(m.fields) > 0 {
		output += " fields:"
		for k, v := range m.fields {
			output += fmt.Sprintf(" %s=%v", k, v)
		}
	}

	// æ·»åŠ ä¼ å…¥çš„å­—æ®µ
	if len(fields) > 0 {
		output += " data:"
		for i, field := range fields {
			if i%2 == 0 && i+1 < len(fields) {
				output += fmt.Sprintf(" %v=%v", field, fields[i+1])
			}
		}
	}

	fmt.Println(output)
}

// ================================
// ç®€åŒ–ç‰ˆ Kart Logger å®žçŽ°ï¼ˆä¸æ”¯æŒ WithFieldï¼‰
// ================================

type SimpleMockKartLogger struct {
	prefix string
}

func NewSimpleMockKartLogger(prefix string) *SimpleMockKartLogger {
	return &SimpleMockKartLogger{prefix: prefix}
}

func (s *SimpleMockKartLogger) Debug(msg string, fields ...interface{}) {
	s.log("DEBUG", msg, fields...)
}

func (s *SimpleMockKartLogger) Info(msg string, fields ...interface{}) {
	s.log("INFO", msg, fields...)
}

func (s *SimpleMockKartLogger) Warn(msg string, fields ...interface{}) {
	s.log("WARN", msg, fields...)
}

func (s *SimpleMockKartLogger) Error(msg string, fields ...interface{}) {
	s.log("ERROR", msg, fields...)
}

func (s *SimpleMockKartLogger) Debugf(format string, args ...interface{}) {
	s.log("DEBUG", fmt.Sprintf(format, args...))
}

func (s *SimpleMockKartLogger) Infof(format string, args ...interface{}) {
	s.log("INFO", fmt.Sprintf(format, args...))
}

func (s *SimpleMockKartLogger) Warnf(format string, args ...interface{}) {
	s.log("WARN", fmt.Sprintf(format, args...))
}

func (s *SimpleMockKartLogger) Errorf(format string, args ...interface{}) {
	s.log("ERROR", fmt.Sprintf(format, args...))
}

func (s *SimpleMockKartLogger) log(level, msg string, fields ...interface{}) {
	timestamp := time.Now().Format("2006-01-02 15:04:05")
	output := fmt.Sprintf("[%s] [%s] %s%s", timestamp, level, s.prefix, msg)

	if len(fields) > 0 {
		output += " data:"
		for i, field := range fields {
			if i%2 == 0 && i+1 < len(fields) {
				output += fmt.Sprintf(" %v=%v", field, fields[i+1])
			}
		}
	}

	fmt.Println(output)
}

// ================================
// ä¸»å‡½æ•°æ¼”ç¤º
// ================================

func main() {
	log.Println("ðŸš€ NotifyHub Kart Logger é€‚é…å™¨æ¼”ç¤º")
	log.Println("=========================================")

	ctx := context.Background()

	// ========================================
	// ç¤ºä¾‹1ï¼šä½¿ç”¨å®Œæ•´çš„ Kart Loggerï¼ˆæ”¯æŒ WithFieldï¼‰
	// ========================================
	log.Println("\nðŸ“ ç¤ºä¾‹1: ä½¿ç”¨å®Œæ•´çš„ Kart Logger é€‚é…å™¨")
	log.Println("---------------------------------")

	// åˆ›å»º Kart Logger å®žä¾‹
	kartLogger := NewMockKartLogger("[NOTIFYHUB] ")

	hub1, err := client.New(
		config.WithFeishu("https://httpbin.org/post", ""),
		notifyhub.WithLogger(
			client.NewKartLoggerAdapter(kartLogger, notifyhub.LogLevelInfo),
		),
		config.WithQueue("memory", 100, 1),
	)
	if err != nil {
		log.Fatalf("Failed to create hub1: %v", err)
	}

	if err := hub1.Start(ctx); err != nil {
		log.Fatalf("Failed to start hub1: %v", err)
	}

	// å‘é€æ¶ˆæ¯
	message1 := client.NewAlert("Kart Logger æµ‹è¯•", "ä½¿ç”¨å®Œæ•´ Kart Logger çš„æµ‹è¯•æ¶ˆæ¯").
		Variable("test_type", "full_kart_logger").
		Variable("timestamp", time.Now().Unix()).
		FeishuGroup("test-group").
		Build()

	_, err = hub1.Send(ctx, message1, nil)
	if err != nil {
		log.Printf("Send failed: %v", err)
	} else {
		log.Printf("å®Œæ•´ Kart Logger æ¶ˆæ¯å‘é€æˆåŠŸ")
	}

	hub1.Stop()

	// ========================================
	// ç¤ºä¾‹2ï¼šä½¿ç”¨ç®€åŒ–ç‰ˆ Kart Loggerï¼ˆä¸æ”¯æŒ WithFieldï¼‰
	// ========================================
	log.Println("\nðŸ“ ç¤ºä¾‹2: ä½¿ç”¨ç®€åŒ–ç‰ˆ Kart Logger é€‚é…å™¨")
	log.Println("---------------------------------")

	// åˆ›å»ºç®€åŒ–ç‰ˆ Kart Logger å®žä¾‹
	simpleKartLogger := NewSimpleMockKartLogger("[SIMPLE-NOTIFYHUB] ")

	hub2, err := client.New(
		config.WithFeishu("https://httpbin.org/post", ""),
		notifyhub.WithLogger(
			client.NewSimpleKartLoggerAdapter(simpleKartLogger, notifyhub.LogLevelDebug),
		),
		config.WithQueue("memory", 100, 1),
	)
	if err != nil {
		log.Fatalf("Failed to create hub2: %v", err)
	}

	if err := hub2.Start(ctx); err != nil {
		log.Fatalf("Failed to start hub2: %v", err)
	}

	// å‘é€æ¶ˆæ¯ï¼ˆDebug çº§åˆ«ä¼šæ˜¾ç¤ºæ›´å¤šä¿¡æ¯ï¼‰
	message2 := client.NewReport("ç®€åŒ–ç‰ˆæµ‹è¯•", "ä½¿ç”¨ç®€åŒ–ç‰ˆ Kart Logger çš„æµ‹è¯•æŠ¥å‘Š").
		Variable("test_type", "simple_kart_logger").
		Variable("debug_enabled", true).
		FeishuGroup("debug-group").
		Build()

	_, err = hub2.Send(ctx, message2, nil)
	if err != nil {
		log.Printf("Send failed: %v", err)
	} else {
		log.Printf("ç®€åŒ–ç‰ˆ Kart Logger æ¶ˆæ¯å‘é€æˆåŠŸ")
	}

	hub2.Stop()

	// ========================================
	// ç¤ºä¾‹3ï¼šä½¿ç”¨ä¸åŒæ—¥å¿—çº§åˆ«çš„å¯¹æ¯”
	// ========================================
	log.Println("\nðŸ“ ç¤ºä¾‹3: ä¸åŒæ—¥å¿—çº§åˆ«å¯¹æ¯”")
	log.Println("---------------------------------")

	// Error çº§åˆ«ï¼ˆåªæ˜¾ç¤ºé”™è¯¯ï¼‰
	log.Println("--- Error çº§åˆ«æ—¥å¿— ---")
	kartLoggerError := NewMockKartLogger("[ERROR-ONLY] ")
	hub3, _ := client.New(
		config.WithFeishu("https://httpbin.org/post", ""),
		notifyhub.WithLogger(
			client.NewKartLoggerAdapter(kartLoggerError, notifyhub.LogLevelError),
		),
		config.WithQueue("memory", 50, 1),
	)

	hub3.Start(ctx)
	message3 := client.NewNotice("Errorçº§åˆ«", "åªæ˜¾ç¤ºé”™è¯¯çš„æµ‹è¯•").
		FeishuGroup("error-group").
		Build()
	_, _ = hub3.Send(ctx, message3, nil)
	hub3.Stop()

	time.Sleep(500 * time.Millisecond)

	// Debug çº§åˆ«ï¼ˆæ˜¾ç¤ºæ‰€æœ‰ä¿¡æ¯ï¼‰
	log.Println("\n--- Debug çº§åˆ«æ—¥å¿— ---")
	kartLoggerDebug := NewMockKartLogger("[DEBUG-ALL] ")
	hub4, _ := client.New(
		config.WithFeishu("https://httpbin.org/post", ""),
		notifyhub.WithLogger(
			client.NewKartLoggerAdapter(kartLoggerDebug, notifyhub.LogLevelDebug),
		),
		config.WithQueue("memory", 50, 1),
	)

	hub4.Start(ctx)
	message4 := client.NewNotice("Debugçº§åˆ«", "æ˜¾ç¤ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯çš„æµ‹è¯•").
		FeishuGroup("debug-group").
		Build()
	_, _ = hub4.Send(ctx, message4, nil)
	hub4.Stop()

	log.Println("\nðŸŽ‰ Kart Logger é€‚é…å™¨æ¼”ç¤ºå®Œæˆ!")
	log.Println("=========================================")
	log.Println("ðŸ’¡ ä½¿ç”¨è¯´æ˜Ž:")
	log.Println("â€¢ å®Œæ•´ç‰ˆé€‚é…å™¨: æ”¯æŒ WithField/WithFields ç»“æž„åŒ–æ—¥å¿—")
	log.Println("â€¢ ç®€åŒ–ç‰ˆé€‚é…å™¨: é€‚ç”¨äºŽä¸æ”¯æŒ WithField çš„ç®€å•å®žçŽ°")
	log.Println("â€¢ è‡ªåŠ¨æ£€æµ‹: æ ¹æ®å®žé™…çš„ Kart Logger æŽ¥å£é€‰æ‹©åˆé€‚çš„é€‚é…å™¨")
	log.Println("â€¢ å…¼å®¹æ€§: å®Œå…¨å…¼å®¹ github.com/kart-io/logger æŽ¥å£")
}
