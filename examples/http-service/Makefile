# NotifyHub HTTP Service Makefile

.PHONY: help run build test clean docker-build docker-run dev deps

# é»˜è®¤ç›®æ ‡
help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "NotifyHub HTTP Service - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

# å¼€å‘ç›¸å…³
dev: deps ## å¼€å‘æ¨¡å¼è¿è¡Œï¼ˆè‡ªåŠ¨é‡å¯ï¼‰
	@echo "ðŸ”§ å¼€å‘æ¨¡å¼å¯åŠ¨..."
	@if command -v air >/dev/null 2>&1; then \
		air; \
	else \
		echo "ðŸ“¦ å®‰è£… air å·¥å…·..."; \
		go install github.com/cosmtrek/air@latest; \
		air; \
	fi

run: ## ç›´æŽ¥è¿è¡ŒæœåŠ¡
	@echo "ðŸš€ å¯åŠ¨ NotifyHub HTTP Service..."
	@go run main.go

deps: ## å®‰è£…ä¾èµ–
	@echo "ðŸ“¦ å®‰è£…ä¾èµ–..."
	@go mod tidy
	@go mod download

# æž„å»ºç›¸å…³
build: ## æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
	@echo "ðŸ”¨ æž„å»ºåº”ç”¨..."
	@CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o bin/notifyhub-http-service main.go
	@echo "âœ… æž„å»ºå®Œæˆ: bin/notifyhub-http-service"

build-local: ## æž„å»ºæœ¬åœ°ç‰ˆæœ¬
	@echo "ðŸ”¨ æž„å»ºæœ¬åœ°ç‰ˆæœ¬..."
	@go build -o bin/notifyhub-http-service main.go
	@echo "âœ… æž„å»ºå®Œæˆ: bin/notifyhub-http-service"

# æµ‹è¯•ç›¸å…³
test: ## è¿è¡Œæµ‹è¯•
	@echo "ðŸ§ª è¿è¡Œæµ‹è¯•..."
	@go test -v ./...

test-coverage: ## è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Š
	@echo "ðŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š..."
	@go test -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… è¦†ç›–çŽ‡æŠ¥å‘Š: coverage.html"

# Docker ç›¸å…³
docker-build: ## æž„å»º Docker é•œåƒ
	@echo "ðŸ³ æž„å»º Docker é•œåƒ..."
	@docker build -t notifyhub-http-service:latest .
	@echo "âœ… Docker é•œåƒæž„å»ºå®Œæˆ"

docker-run: ## è¿è¡Œ Docker å®¹å™¨
	@echo "ðŸ³ è¿è¡Œ Docker å®¹å™¨..."
	@docker run -p 8080:8080 --env-file .env notifyhub-http-service:latest

# æœåŠ¡ç®¡ç†
start: build-local ## æž„å»ºå¹¶å¯åŠ¨æœåŠ¡
	@echo "ðŸš€ å¯åŠ¨æœåŠ¡..."
	@./bin/notifyhub-http-service

stop: ## åœæ­¢æœåŠ¡ï¼ˆå¦‚æžœåœ¨åŽå°è¿è¡Œï¼‰
	@echo "ðŸ›‘ åœæ­¢æœåŠ¡..."
	@pkill -f notifyhub-http-service || true

restart: stop start ## é‡å¯æœåŠ¡

# å·¥å…·å‘½ä»¤
fmt: ## æ ¼å¼åŒ–ä»£ç 
	@echo "ðŸŽ¨ æ ¼å¼åŒ–ä»£ç ..."
	@go fmt ./...

lint: ## è¿è¡Œä»£ç æ£€æŸ¥
	@echo "ðŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run; \
	else \
		echo "ðŸ“¦ è¯·å®‰è£… golangci-lint: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"; \
	fi

# æ¸…ç†
clean: ## æ¸…ç†æž„å»ºæ–‡ä»¶
	@echo "ðŸ§¹ æ¸…ç†æž„å»ºæ–‡ä»¶..."
	@rm -rf bin/
	@rm -f coverage.out coverage.html
	@echo "âœ… æ¸…ç†å®Œæˆ"

# ç¤ºä¾‹å’Œæµ‹è¯•
example-curl: ## è¿è¡Œ curl ç¤ºä¾‹æµ‹è¯•
	@echo "ðŸ“¡ æµ‹è¯• API æŽ¥å£..."
	@echo "å¥åº·æ£€æŸ¥:"
	@curl -s http://localhost:8080/api/v1/health | jq '.' || curl -s http://localhost:8080/api/v1/health
	@echo ""
	@echo "å‘é€æµ‹è¯•é€šçŸ¥:"
	@curl -s -X POST http://localhost:8080/api/v1/notifications \
		-H "Content-Type: application/json" \
		-d '{"type":"notice","title":"æµ‹è¯•","message":"Hello NotifyHub!","targets":[{"type":"email","value":"test@example.com"}]}' \
		| jq '.' || echo "éœ€è¦å®‰è£… jq æ¥æ ¼å¼åŒ– JSON è¾“å‡º"

setup: ## åˆå§‹åŒ–é¡¹ç›®çŽ¯å¢ƒ
	@echo "ðŸ”§ åˆå§‹åŒ–é¡¹ç›®çŽ¯å¢ƒ..."
	@cp .env.example .env || true
	@echo "âœ… è¯·ç¼–è¾‘ .env æ–‡ä»¶é…ç½®æ‚¨çš„é€šçŸ¥æ¸ é“"
	@echo "ðŸ“– ç„¶åŽè¿è¡Œ: make run"

# ç”Ÿäº§éƒ¨ç½²
deploy-prep: test build ## å‡†å¤‡ç”Ÿäº§éƒ¨ç½²
	@echo "ðŸš€ å‡†å¤‡ç”Ÿäº§éƒ¨ç½²..."
	@echo "âœ… æµ‹è¯•é€šè¿‡ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶å·²æž„å»º"

# ç‰ˆæœ¬ä¿¡æ¯
version: ## æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
	@echo "NotifyHub HTTP Service v1.2.0"
	@echo "Go version: $(shell go version)"
	@echo "Git commit: $(shell git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help