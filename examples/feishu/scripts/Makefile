# é£ä¹¦é€šçŸ¥ç¤ºä¾‹ Makefile

.PHONY: help build-all build-example build-debug build-test run example debug test demo deps clean fmt vet check

# é»˜è®¤ç›®æ ‡
help:
	@echo "é£ä¹¦é€šçŸ¥ç¤ºä¾‹ - å¯ç”¨å‘½ä»¤:"
	@echo "  make build-all    - æ„å»ºæ‰€æœ‰ç¨‹åº"
	@echo "  make build-example- æ„å»ºç¤ºä¾‹ç¨‹åº"
	@echo "  make build-debug  - æ„å»ºè°ƒè¯•å·¥å…·"
	@echo "  make build-test   - æ„å»ºæµ‹è¯•å·¥å…·"
	@echo ""
	@echo "  make example      - è¿è¡Œç¤ºä¾‹ç¨‹åºï¼ˆéœ€è¦è®¾ç½®ç¯å¢ƒå˜é‡ï¼‰"
	@echo "  make debug        - è¿è¡Œè°ƒè¯•å·¥å…·ï¼ˆç›´æ¥HTTPè¯·æ±‚ï¼‰"
	@echo "  make test         - è¿è¡ŒçœŸå®ç¯å¢ƒæµ‹è¯•"
	@echo "  make demo         - è¿è¡Œæ¼”ç¤ºï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰"
	@echo ""
	@echo "  make deps         - ä¸‹è½½æ‰€æœ‰ä¾èµ–"
	@echo "  make clean        - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  make fmt          - æ ¼å¼åŒ–ä»£ç "
	@echo "  make vet          - ä»£ç æ£€æŸ¥"
	@echo "  make check        - å®Œæ•´æ£€æŸ¥"
	@echo "  make help         - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ç¯å¢ƒå˜é‡é…ç½®:"
	@echo "  FEISHU_WEBHOOK_URL  - é£ä¹¦ Webhook URLï¼ˆå¿…éœ€ï¼‰"
	@echo "  FEISHU_SECRET       - é£ä¹¦ç­¾åå¯†é’¥ï¼ˆå¯é€‰ï¼‰"
	@echo ""
	@echo "é¡¹ç›®ç»“æ„:"
	@echo "  cmd/example/      - ä¸»è¦ç¤ºä¾‹ç¨‹åºï¼ˆ6ç§åœºæ™¯æ¼”ç¤ºï¼‰"
	@echo "  cmd/debug/        - è°ƒè¯•å·¥å…·ï¼ˆç›´æ¥HTTPæµ‹è¯•ï¼‰"
	@echo "  cmd/test/         - æµ‹è¯•å·¥å…·ï¼ˆNotifyHubé›†æˆæµ‹è¯•ï¼‰"

# æ„å»ºæ‰€æœ‰ç¨‹åº
build-all: build-example build-debug build-test

# æ„å»ºç¤ºä¾‹ç¨‹åº
build-example:
	@echo "ğŸ”¨ æ„å»ºç¤ºä¾‹ç¨‹åº..."
	cd ../cmd/example && go build -o feishu-example main.go
	@echo "âœ… æ„å»ºå®Œæˆ: cmd/example/feishu-example"

# æ„å»ºè°ƒè¯•å·¥å…·
build-debug:
	@echo "ğŸ”¨ æ„å»ºè°ƒè¯•å·¥å…·..."
	cd ../cmd/debug && go build -o debug-sender main.go
	@echo "âœ… æ„å»ºå®Œæˆ: cmd/debug/debug-sender"

# æ„å»ºæµ‹è¯•å·¥å…·
build-test:
	@echo "ğŸ”¨ æ„å»ºæµ‹è¯•å·¥å…·..."
	cd ../cmd/test && go build -o test-real main.go
	@echo "âœ… æ„å»ºå®Œæˆ: cmd/test/test-real"

# è¿è¡Œç¤ºä¾‹ç¨‹åºï¼ˆéœ€è¦ç¯å¢ƒå˜é‡ï¼‰
example:
	@echo "ğŸš€ è¿è¡Œé£ä¹¦é€šçŸ¥ç¤ºä¾‹..."
	@if [ -z "$(FEISHU_WEBHOOK_URL)" ]; then \
		echo "âŒ é”™è¯¯: è¯·è®¾ç½®ç¯å¢ƒå˜é‡ FEISHU_WEBHOOK_URL"; \
		echo "   export FEISHU_WEBHOOK_URL=\"https://open.feishu.cn/open-apis/bot/v2/hook/your-token\""; \
		exit 1; \
	fi
	cd ../cmd/example && go run main.go

# è¿è¡Œè°ƒè¯•å·¥å…·ï¼ˆç›´æ¥ HTTP è¯·æ±‚ï¼‰
debug:
	@echo "ğŸ§ª è¿è¡Œé£ä¹¦è°ƒè¯•å·¥å…·..."
	@if [ -z "$(FEISHU_WEBHOOK_URL)" ]; then \
		echo "âŒ é”™è¯¯: è¯·è®¾ç½®ç¯å¢ƒå˜é‡ FEISHU_WEBHOOK_URL"; \
		echo "   export FEISHU_WEBHOOK_URL=\"https://open.feishu.cn/open-apis/bot/v2/hook/your-token\""; \
		exit 1; \
	fi
	cd ../cmd/debug && go run main.go

# è¿è¡ŒçœŸå®ç¯å¢ƒæµ‹è¯•ï¼ˆNotifyHub é›†æˆï¼‰
test:
	@echo "ğŸ§ª è¿è¡Œ NotifyHub çœŸå®ç¯å¢ƒæµ‹è¯•..."
	@if [ -z "$(FEISHU_WEBHOOK_URL)" ]; then \
		echo "âŒ é”™è¯¯: è¯·è®¾ç½®ç¯å¢ƒå˜é‡ FEISHU_WEBHOOK_URL"; \
		echo "   export FEISHU_WEBHOOK_URL=\"https://open.feishu.cn/open-apis/bot/v2/hook/your-token\""; \
		exit 1; \
	fi
	cd ../cmd/test && go run main.go

# è¿è¡Œæ¼”ç¤ºï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
demo:
	@echo "ğŸ­ è¿è¡Œé£ä¹¦é€šçŸ¥æ¼”ç¤º..."
	./demo.sh

# ä¸‹è½½ä¾èµ–
deps:
	@echo "ğŸ“¦ ä¸‹è½½ä¾èµ–..."
	cd ../cmd/example && go mod tidy && go mod download
	cd ../cmd/debug && go mod tidy && go mod download
	cd ../cmd/test && go mod tidy && go mod download
	@echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	rm -f ../cmd/example/feishu-example
	rm -f ../cmd/debug/debug-sender
	rm -f ../cmd/test/test-real
	cd ../cmd/example && go clean
	cd ../cmd/debug && go clean
	cd ../cmd/test && go clean
	@echo "âœ… æ¸…ç†å®Œæˆ"

# éªŒè¯ä»£ç 
vet:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	cd ../cmd/example && go vet ./...
	cd ../cmd/debug && go vet ./...
	cd ../cmd/test && go vet ./...
	@echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ğŸ“ æ ¼å¼åŒ–ä»£ç ..."
	cd ../cmd/example && go fmt ./...
	cd ../cmd/debug && go fmt ./...
	cd ../cmd/test && go fmt ./...
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# å®Œæ•´æ£€æŸ¥
check: fmt vet build-all
	@echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"

# å…¼å®¹æ€§åˆ«å
run: example
build: build-example
test-real: test