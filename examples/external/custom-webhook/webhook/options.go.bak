package webhook

import (
	"fmt"
	"sync"
	"time"

	"github.com/kart-io/notifyhub/pkg/notifyhub"
)

var (
	registerOnce sync.Once
)

// ensureRegistered ensures the Webhook platform is registered with NotifyHub
func ensureRegistered() {
	registerOnce.Do(func() {
		notifyhub.RegisterExtension(&notifyhub.PlatformExtension{
			Name:    "webhook",
			Creator: NewWebhookSender,
			DefaultOpts: func() map[string]interface{} {
				return map[string]interface{}{
					"method":       "POST",
					"content_type": "application/json",
					"timeout":      30 * time.Second,
				}
			},
			Validator: func(config map[string]interface{}) error {
				if _, ok := config["webhook_url"].(string); !ok {
					return fmt.Errorf("webhook_url is required")
				}
				if config["webhook_url"].(string) == "" {
					return fmt.Errorf("webhook_url cannot be empty")
				}
				return nil
			},
		})
	})
}

// WithWebhook creates a HubOption for Webhook platform
func WithWebhook(webhookURL string, options ...func(map[string]interface{})) notifyhub.HubOption {
	ensureRegistered()

	config := map[string]interface{}{
		"webhook_url":  webhookURL,
		"method":       "POST",
		"content_type": "application/json",
		"timeout":      30 * time.Second,
	}

	// Apply additional options
	for _, opt := range options {
		opt(config)
	}

	return notifyhub.WithCustomPlatform("webhook", config)
}

// WithWebhookMethod sets the HTTP method for webhook requests
func WithWebhookMethod(method string) func(map[string]interface{}) {
	return func(config map[string]interface{}) {
		config["method"] = method
	}
}

// WithWebhookContentType sets the content type for webhook requests
func WithWebhookContentType(contentType string) func(map[string]interface{}) {
	return func(config map[string]interface{}) {
		config["content_type"] = contentType
	}
}

// WithWebhookHeaders adds custom headers to webhook requests
func WithWebhookHeaders(headers map[string]string) func(map[string]interface{}) {
	return func(config map[string]interface{}) {
		config["headers"] = headers
	}
}

// WithWebhookPayloadTemplate sets a custom payload template
func WithWebhookPayloadTemplate(template map[string]interface{}) func(map[string]interface{}) {
	return func(config map[string]interface{}) {
		config["payload_template"] = template
	}
}

// WithWebhookTimeout sets the timeout for webhook requests
func WithWebhookTimeout(timeout time.Duration) func(map[string]interface{}) {
	return func(config map[string]interface{}) {
		config["timeout"] = timeout
	}
}