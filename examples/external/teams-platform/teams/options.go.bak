package teams

import (
	"fmt"
	"sync"
	"time"

	"github.com/kart-io/notifyhub/pkg/notifyhub"
)

var (
	registerOnce sync.Once
)

// ensureRegistered ensures the Teams platform is registered with NotifyHub
func ensureRegistered() {
	registerOnce.Do(func() {
		notifyhub.RegisterExtension(&notifyhub.PlatformExtension{
			Name:    "teams",
			Creator: NewTeamsSender,
			DefaultOpts: func() map[string]interface{} {
				return map[string]interface{}{
					"timeout": 30 * time.Second,
				}
			},
			Validator: func(config map[string]interface{}) error {
				if _, ok := config["webhook_url"].(string); !ok {
					return fmt.Errorf("webhook_url is required")
				}
				if config["webhook_url"].(string) == "" {
					return fmt.Errorf("webhook_url cannot be empty")
				}
				return nil
			},
		})
	})
}

// WithTeams creates a HubOption for Microsoft Teams platform
func WithTeams(webhookURL string, options ...func(map[string]interface{})) notifyhub.HubOption {
	ensureRegistered()

	config := map[string]interface{}{
		"webhook_url": webhookURL,
		"timeout":     30 * time.Second,
	}

	// Apply additional options
	for _, opt := range options {
		opt(config)
	}

	return notifyhub.WithCustomPlatform("teams", config)
}

// WithTeamsTimeout sets the timeout for Teams requests
func WithTeamsTimeout(timeout time.Duration) func(map[string]interface{}) {
	return func(config map[string]interface{}) {
		config["timeout"] = timeout
	}
}