# NotifyHub 架构重构实现任务列表

## 阶段0：架构基础重构和巨型文件拆分（优先级：最高）

- [ ] 0. 重构 feishu/sender.go 巨型文件（669行 → 多文件）
  - [ ] 0.1 拆分飞书平台核心实现
    - 创建 `pkg/platforms/feishu/platform.go` 实现统一 Platform 接口（约150行）
    - 将 FeishuSender 重构为 FeishuPlatform，实现 Send、ValidateTarget、GetCapabilities 方法
    - 集成认证、消息构建和发送逻辑到主平台实现
    - 确保单个文件不超过300行，职责单一明确
    - _Requirements: 12.3, 12.4, 5.1_

  - [ ] 0.2 创建飞书消息构建器
    - 创建 `pkg/platforms/feishu/message.go` 专门负责消息构建（约120行）
    - 实现 MessageBuilder 结构体，支持文本、富文本消息格式转换
    - 处理关键词要求和消息大小限制检查
    - 提供消息格式验证和安全检查功能
    - _Requirements: 12.3, 5.3_

  - [ ] 0.3 创建飞书认证处理器
    - 创建 `pkg/platforms/feishu/auth.go` 专门负责认证逻辑（约100行）
    - 实现 AuthHandler 结构体，处理签名验证和关键词检查
    - 实现安全模式检测和签名生成逻辑
    - 提供认证错误的详细诊断信息
    - _Requirements: 12.3, 6.1_

  - [ ] 0.4 创建飞书配置管理
    - 创建 `pkg/platforms/feishu/config.go` 配置结构和验证（约80行）
    - 定义 FeishuConfig 结构体，包含 WebhookURL、Secret、Keywords 字段
    - 实现配置验证和默认值设置逻辑
    - 提供配置序列化和环境变量加载支持
    - _Requirements: 12.3, 4.3_

  - [ ] 0.5 创建飞书HTTP客户端封装
    - 创建 `pkg/platforms/feishu/client.go` HTTP客户端封装（约100行）
    - 实现 HTTPClient 结构体，封装HTTP请求和响应处理
    - 添加重试机制、超时控制和错误处理
    - 提供连接池管理和健康检查功能
    - _Requirements: 12.3, 6.4_

  - [ ] 0.6 验证飞书平台重构
    - 创建飞书平台各模块的单元测试文件
    - 验证拆分后的文件大小和职责符合要求
    - 测试平台功能完整性和性能表现
    - 确保与现有系统的兼容性
    - _Requirements: 12.1, 12.4_

- [ ] 1. 完善全局状态消除和实例级架构
  - [ ] 1.1 验证并完善平台注册表实例化
    - 检查 `pkg/platform/registry.go` 的实例级实现
    - 确保线程安全的注册、查询、注销方法已实现
    - 验证 Client 结构体包含实例级 registry 字段
    - 创建并发安全性测试验证多实例隔离
    - _Requirements: 11.1, 11.2, 11.3_

  - [ ] 1.2 消除 hub_factory.go 的职责混杂
    - 检查现有 `pkg/notifyhub/client/factory.go` 实现
    - 分离配置选项处理到独立的 options.go 文件
    - 分离配置验证逻辑到独立的 validator.go 文件
    - 确保工厂文件专注于客户端创建职责
    - _Requirements: 12.1, 12.2, 12.5_

  - [ ] 1.3 验证依赖注入架构实现
    - 检查客户端创建是否已使用实例级依赖注入
    - 移除任何残留的全局状态依赖
    - 实现平台工厂函数模式验证
    - 创建多实例并发使用的集成测试
    - _Requirements: 11.4, 11.5_

  - [ ] 1.4 简化调用链路验证
    - 验证调用链路已从6层简化到3层（Client → Dispatcher → Platform）
    - 检查是否移除了 clientAdapter 等中间层
    - 实施性能基准测试验证30%提升目标
    - 创建调用链路性能对比报告
    - _Requirements: 3.1, 3.4, 14.1_

## 阶段1：统一数据模型和接口验证

- [ ] 2. 验证并完善统一消息模型
  - [ ] 2.1 检查消息模型现状和重复定义
    - 检查现有 `pkg/notifyhub/message/message.go` 的实现完整性
    - 识别系统中 Message 类型的重复定义并统一
    - 验证 Format 和 Priority 枚举的完整性和一致性
    - 确保 JSON 序列化标签和验证标签已正确添加
    - _Requirements: 1.3, 3.3_

  - [ ] 2.2 完善消息构建器和验证逻辑
    - 检查 `pkg/notifyhub/message/builder.go` 的构建器实现
    - 验证 NewMessage(), SetTitle(), SetBody(), AddTarget() 等方法
    - 实现缺失的验证逻辑：内容长度、格式、目标数量验证
    - 添加消息构建器的错误处理和边界条件检查
    - _Requirements: 1.3, 6.1_

  - [ ] 2.3 补充消息模型单元测试
    - 检查现有 `pkg/notifyhub/message/message_test.go` 测试覆盖率
    - 补充缺失的边界条件测试：空消息、过长内容、无效格式
    - 添加构建器模式链式调用的测试用例
    - 实现性能基准测试验证消息创建效率
    - _Requirements: 1.3_

- [ ] 3. 统一和完善目标模型
  - [ ] 3.1 检查目标模型现状和重复定义
    - 检查现有 `pkg/notifyhub/target/target.go` 的 Target 结构体
    - 识别并消除系统中 Target 类型的重复定义
    - 验证目标类型常量的完整性和一致性
    - 检查 NewTarget() 工厂函数和验证方法的实现
    - _Requirements: 1.3, 5.3_

  - [ ] 3.2 完善目标解析器功能
    - 检查现有 `pkg/notifyhub/target/resolver.go` 的解析器实现
    - 实现缺失的自动目标类型检测功能（邮箱、电话模式）
    - 添加目标标准化和验证逻辑
    - 实现批量目标解析和去重功能
    - _Requirements: 5.3_

  - [ ] 3.3 补充目标模型测试用例
    - 检查现有目标模型的测试覆盖率
    - 补充各种目标类型的创建和验证测试
    - 添加目标解析器自动检测功能的测试
    - 实现无效目标错误处理的测试用例
    - _Requirements: 1.3, 5.3_

- [ ] 4. 验证统一回执模型
  - [ ] 4.1 检查回执模型实现状态
    - 检查现有 `pkg/notifyhub/receipt/receipt.go` 的实现
    - 验证 Receipt 和 PlatformResult 结构体的完整性
    - 检查状态枚举和时间戳追踪功能
    - 验证回执聚合统计方法的正确性
    - _Requirements: 2.2, 2.4_

  - [ ] 4.2 完善回执处理器逻辑
    - 检查现有 `pkg/notifyhub/receipt/processor.go` 的实现
    - 完善多平台结果聚合逻辑
    - 实现部分失败场景的状态计算
    - 添加回执序列化和持久化接口
    - _Requirements: 2.2, 2.4_

  - [ ] 4.3 补充回执模型测试
    - 检查回执模型的测试覆盖率
    - 补充回执聚合和状态计算的测试
    - 添加各种成功/失败组合场景的测试
    - 实现回执序列化和反序列化的测试
    - _Requirements: 2.2, 2.4_

- [ ] 5. 完善统一平台接口
  - [ ] 5.1 检查平台接口定义
    - 检查现有 `pkg/notifyhub/platform/interface.go` 的 Platform 接口
    - 验证 Send、ValidateTarget、GetCapabilities、IsHealthy、Close 方法定义
    - 确保 Capabilities 和 SendResult 结构体完整性
    - 检查接口的版本兼容性和扩展性
    - _Requirements: 5.1, 5.2_

  - [ ] 5.2 完善平台注册表实现
    - 检查现有 `pkg/platform/registry.go` 的注册表实现
    - 验证实例级注册表的线程安全性
    - 完善平台注册、查询、注销的方法实现
    - 添加平台生命周期管理和健康检查
    - _Requirements: 5.1, 5.5_

  - [ ] 5.3 补充平台接口契约测试
    - 创建平台接口的契约测试套件
    - 定义所有平台实现必须通过的测试用例
    - 测试平台能力查询和目标验证功能
    - 验证平台健康检查和错误处理逻辑
    - _Requirements: 5.1, 5.2_

## 阶段2：错误处理和异步系统完善

- [ ] 6. 完善统一错误处理系统
  - [ ] 6.1 检查和完善错误类型定义
    - 检查现有 `pkg/notifyhub/errors/` 包的实现状态
    - 验证 ErrorCode 类型和分类的完整性
    - 检查 NotifyError 结构体和错误包装方法
    - 实现缺失的错误上下文收集和格式化功能
    - _Requirements: 6.1, 6.2_

  - [ ] 6.2 完善重试策略实现
    - 检查现有 `pkg/notifyhub/errors/retry.go` 的重试策略
    - 验证 RetryableError 接口和重试决策逻辑
    - 完善指数退避算法的抖动和间隔限制
    - 添加重试次数跟踪和统计功能
    - _Requirements: 6.4_

  - [ ] 6.3 补充错误处理测试
    - 检查错误处理模块的测试覆盖率
    - 补充错误创建、分类、包装的测试用例
    - 添加重试策略算法的单元测试
    - 实现各种错误类型可重试判断的测试
    - _Requirements: 6.1, 6.2, 6.4_

## 阶段3：真正异步处理系统实现

- [ ] 7. 实现真正的异步处理系统
  - [ ] 7.1 检查和完善异步队列实现
    - 检查现有 `pkg/notifyhub/async/queue.go` 的队列接口
    - 验证内存队列和 Redis 队列的实现状态
    - 实现缺失的优先级队列和延迟队列功能
    - 确保队列的并发安全性和容量限制
    - _Requirements: 2.1, 2.5_

  - [ ] 7.2 完善异步句柄管理系统
    - 检查现有 `pkg/notifyhub/async/handle.go` 的句柄实现
    - 实现缺失的状态管理（Pending、Running、Success、Failed）
    - 完善异步操作的取消和超时控制机制
    - 实现 Wait() 方法的阻塞等待和结果获取
    - _Requirements: 2.6, 2.4_

  - [ ] 7.3 实现回调管理系统
    - 检查现有 `pkg/notifyhub/async/callback.go` 的回调实现
    - 实现 CompletionCallback、ErrorCallback、ProgressCallback 类型
    - 建立异步回调执行引擎避免阻塞主流程
    - 实现回调执行状态跟踪和错误恢复机制
    - _Requirements: 2.2, 2.3, 2.4_

  - [ ] 7.4 完善工作器池实现
    - 检查现有 `pkg/notifyhub/async/worker.go` 的工作器池
    - 实现动态工作器数量调整和负载均衡
    - 完善任务分发和工作器状态监控
    - 添加工作器池的优雅启动和关闭机制
    - _Requirements: 2.1, 2.4_

  - [ ] 7.5 验证异步处理的真实性
    - 创建测试验证 SendAsync 使用真实队列而非同步调用
    - 验证异步操作状态的正确反映和更新
    - 测试异步处理的并发性和资源隔离
    - 实现异步操作性能基准测试
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

## 阶段4：配置系统统一化

- [ ] 8. 完善配置系统统一化
  - [ ] 8.1 检查核心配置系统实现
    - 检查现有 `pkg/notifyhub/config/config.go` 的配置结构体
    - 验证 Option 函数类型和配置选项模式的实现
    - 检查配置默认值和环境变量支持
    - 确保配置验证和错误处理的完整性
    - _Requirements: 4.1, 4.2_

  - [ ] 8.2 验证平台配置的强类型实现
    - 检查各平台配置是否已实现强类型结构体
    - 验证 WithFeishu、WithEmail 等选项函数
    - 确保废弃 map 配置方式，统一使用强类型配置
    - 实现配置验证和序列化功能
    - _Requirements: 4.3, 9.4_

  - [ ] 8.3 补充配置系统测试
    - 检查配置系统的测试覆盖率
    - 补充配置构建和选项组合的测试
    - 添加环境变量加载和验证的测试
    - 实现配置系统的性能基准测试
    - _Requirements: 4.1, 4.2_

## 阶段5：完善平台实现和集成测试

- [ ] 9. 完善其他平台实现
  - [ ] 9.1 更新邮件平台实现
    - 检查现有 `pkg/platforms/email/` 平台实现
    - 确保实现统一 Platform 接口方法
    - 使用强类型 EmailConfig 替换 map 配置
    - 集成错误处理和健康检查逻辑
    - _Requirements: 5.1, 5.5_

  - [ ] 9.2 更新 Webhook 平台实现
    - 检查现有 `pkg/platforms/webhook/` 平台实现
    - 确保实现统一 Platform 接口方法
    - 使用强类型 WebhookConfig 替换 map 配置
    - 支持多种认证方式和自定义头部
    - _Requirements: 5.1, 5.5_

  - [ ] 9.3 验证平台接口一致性
    - 创建平台接口的契约测试套件
    - 验证所有平台实现的接口一致性
    - 测试平台能力查询和目标验证
    - 确保平台健康检查和错误处理统一
    - _Requirements: 5.1, 5.2_

- [ ] 10. 创建集成测试和性能验证
  - [ ] 10.1 实现端到端集成测试
    - 创建多平台消息发送的端到端测试
    - 测试异步处理和回调机制的完整性
    - 验证错误处理和重试机制
    - 测试系统在真实环境下的表现
    - _Requirements: 2.1, 2.2, 2.3, 6.1_

  - [ ] 10.2 验证架构目标达成
    - 验证调用链路从6层简化到3层
    - 测量性能提升30%的目标达成
    - 验证内存分配减少40%的目标
    - 确认文件大小和职责符合要求（300行以内）
    - _Requirements: 3.1, 14.1, 12.1_

  - [ ] 10.3 实施性能基准测试
    - 创建新旧实现的性能对比测试
    - 测量消息发送延迟和吞吐量
    - 分析内存使用和资源效率
    - 生成详细的性能对比报告
    - _Requirements: 14.1, 14.4_

- [ ] 11. 向后兼容性和迁移支持
  - [ ] 11.1 实现兼容性包装器
    - 创建兼容性API包装器保持现有接口
    - 实现新旧API之间的转换和适配
    - 提供废弃警告和迁移提示功能
    - 确保现有代码无需修改可运行
    - _Requirements: 9.1, 9.2, 9.3_

  - [ ] 11.2 创建迁移验证测试
    - 创建向后兼容性的完整测试套件
    - 测试现有API的功能保持和性能
    - 验证迁移工具的正确性和安全性
    - 确保兼容层的稳定性和可靠性
    - _Requirements: 9.1, 9.2, 9.3_

  - [ ] 11.3 生成架构重构验证报告
    - 生成架构重构的完整验证报告
    - 提供目标达成情况的量化分析
    - 识别改进点和后续优化方向
    - 建立架构演进的持续评估机制
    - _Requirements: 14.4_

## 任务执行优先级和依赖关系

### 第一优先级（立即执行）

- 阶段0：架构基础重构和巨型文件拆分
- 阶段1：统一数据模型和接口验证

### 第二优先级（基础完成后）

- 阶段2：错误处理和异步系统完善
- 阶段3：真正异步处理系统实现

### 第三优先级（核心功能完成后）

- 阶段4：配置系统统一化
- 阶段5：完善平台实现和集成测试

## 任务执行指南

### 测试驱动开发原则

每个任务都应遵循以下步骤：

1. **先写测试**：为要实现的功能编写单元测试
2. **实现代码**：编写满足测试的最小实现
3. **重构优化**：在测试保护下优化代码结构
4. **集成测试**：确保与现有系统兼容

### 文件大小控制

- 确保任何单个文件不超过300行
- 每个文件职责单一明确
- 使用 `wc -l` 命令验证文件行数

### 性能基准验证

- 在重构前后执行性能基准测试
- 记录调用链路、内存使用、响应时间等指标
- 验证30%性能提升和40%内存减少目标

### 向后兼容性保证

- 现有API必须保持可用
- 提供清晰的迁移路径和文档
- 新旧实现必须通过相同的测试套件

---

**完成说明：**
此任务列表专注于NotifyHub架构重构的核心目标，按优先级组织任务，强调测试驱动开发和增量实现。每个任务都包含明确的交付标准和需求追溯，确保重构过程可控且目标明确。
